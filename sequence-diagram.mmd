%% Mochi Chat Sequence Diagram Guide
%% Based on Mermaid.js
%% Syntax: https://mermaid.js.org/syntax/sequenceDiagram.html

%% 1. Naming Conventions:
%%    - Use descriptive names for participants
%%    - Include file names in participant aliases using <br/>
%%    - Keep messages concise but descriptive
%%    - Use consistent terminology across the diagram
%%
%% 2. Message Types:
%%    - Request: ->> (solid arrow)
%%    - Response: -->> (dashed arrow)
%%    - Error Response: -->> (use same as response)
%%
%% 3. Parallel Operations (par):
%%    - Use for concurrent operations
%%    - Each parallel block should be self-contained
%%    - End with 'and' for additional parallel blocks
%%
%% 4. Critical Sections (critical):
%%    - Use for important operations that require error handling
%%    - Include 'option' blocks for error cases
%%    - Keep critical sections focused on core functionality
%%
%% 5. Grouping (rect):
%%    - Group related operations using rect
%%    - Use rgb(240, 240, 240) for consistent styling
%%    - Label groups with clear section names
%%
%% 6. Activation Bars:
%%    - Use activate/deactivate to show component lifetime
%%    - Show nested activations for call hierarchy
%%    - Ensure proper deactivation order
%%
%% 7. Parameters:
%%    - Show full parameters in notes for important calls
%%    - Mark optional parameters with ?
%%    - Group related parameters together
%%
%% 8. Best Practices:
%%    - Keep the diagram flowing top to bottom
%%    - Group related interactions together
%%    - Include error handling for critical operations
%%    - Show both success and failure paths
%%    - Document complex interactions with parameters
%%

sequenceDiagram
    %% Define all participants upfront for better organization
    participant User
    participant Chrome
    participant Content as Content Script<br/>(content.js)
    participant Background as Background Script<br/>(background.js)
    participant Extract as Text Extractor
    participant Chat as Chat Module<br/>(chat.js)
    participant Conv as Conversation Manager<br/>(conversation.js)
    participant API as Serverless API<br/>(api/chat.js)
    participant OpenAI as OpenAI Handler<br/>(lib/openai.js)
    participant Gemini as Gemini Handler<br/>(lib/gemini.js)

    %% System Initialization
    rect rgb(240, 240, 240)
        Note over User,Gemini: 1. System Initialization
        User->>Chrome: Open webpage
        Chrome->>Content: Tab updated event
        activate Content
        Content->>Background: Log initialization
        Background-->>Content: Logged

        %% Check Hidden Domains before UI Initialization
        Content->>Content: extractBaseDomain()
        Content->>Content: shouldHideChatToggle()
        activate Content
        Content->>Chrome: chrome.storage.local.get()
        Chrome-->>Content: hiddenDomains
        deactivate Content
        
        alt Domain is in Hidden List
            Content->>Content: initializeChatInputHidden()
            Note right of Content: Create UI elements in hidden state
        else Domain is not Hidden
            %% Regular UI Initialization
            Content->>Content: initializeChatInput()
        end
        
        Content->>Content: createChatInterface()
        Content->>Content: hideChatInterface()

        %% Parallel initialization processes
        par Content Extraction
            Content->>Content: extractPageText()
            Content->>Conv: setExtractionComplete(false)
            
            Note right of Content: Dynamic Website Text Extraction
            Content->>Extract: extractText(options)
            activate Extract
            
            Extract->>Extract: Phase 1: Initial Extraction
            Note right of Extract: Extract static content
            
            Extract->>Extract: Phase 2: Wait for Dynamic Content
            Note right of Extract: Use MutationObserver to detect DOM changes
            
            Extract->>Extract: Phase 3: Follow-up Extraction
            Note right of Extract: Capture newly loaded content
            
            Extract->>Extract: Phase 4: Final Deduplication
            Note right of Extract: Process and format extracted text
            
            Extract-->>Content: Extracted Text
            deactivate Extract
            
            Content->>Conv: addExtractedText(text)
            Conv->>Conv: setExtractionComplete(true)
            
            Note over Content: Dynamic Web App Detection
            Content->>Content: checkIfDynamicWebApp()
            Content->>Content: detectArticleContent()
            Note right of Content: Article detection using:<br/>1. Document structure<br/>2. Schema.org metadata<br/>3. Content patterns<br/>4. Text quality assessment
            
            alt Not an Article
                Content->>Content: checkForDynamicLoading()
                Note right of Content: Detects AJAX, WebSockets,<br/>EventSource, and real-time updates
                
                Content->>Content: checkForInfiniteScrolling()
                Content->>Content: checkForRichJSInterface()
                Note right of Content: Detects UI frameworks,<br/>complex UI patterns, and<br/>email client interfaces
                
                Content->>Content: detectJSFrameworks()
                Note right of Content: Identifies React, Angular,<br/>Vue, Ember, and UI libraries
                
                Content->>Content: analyzeDomComplexity()
                Note right of Content: Evaluates DOM structure,<br/>interactive elements, and<br/>layout complexity
                
                Content->>Content: assessContentQuality()
                Note right of Content: Weighted scoring system<br/>with optimized thresholds
            end
        end

        %% Module Loading
        Content->>Chat: loadChatModule()
        activate Chat
        Chat->>Conv: import
        activate Conv
        Conv-->>Chat: conversation module
        Chat-->>Content: chat module loaded
        deactivate Content
    end

    %% User Interaction and Chat Flow
    rect rgb(240, 240, 240)
        Note over User,Gemini: 2. User Interaction
        User->>Content: Toggle chat interface
        activate Content
        Content->>Content: toggleChatInterface()
        Content->>Content: showChatInterface()
        Content-->>User: interface visible
        deactivate Content

        User->>Content: Enter prompt
        activate Content
        Content->>Content: showChatInterface()
        
        %% Prompt Queueing System
        alt Extraction in Progress
            Content->>Conv: isTextExtractionComplete()
            Conv-->>Content: false (extraction in progress)
            Content->>Conv: queuePromptIfNeeded()
            Note right of Content: Prompt queued while extraction completes
            Conv-->>Content: Promise resolves when extraction completes
        end
        
        Content->>Chat: sendPrompt(prompt)
        activate Chat
    end
    
    %% Domain Management for Hidden Chat Toggle
    rect rgb(240, 240, 240)
        Note over User,Gemini: 2.1. Domain Management
        
        %% Hide Chat Toggle Flow
        User->>Content: Click hide button on chat toggle
        activate Content
        Content->>Content: extractBaseDomain()
        Content->>Content: addDomainToHiddenList(domain)
        
        Content->>Chrome: chrome.storage.local.get()
        Chrome-->>Content: hiddenDomains
        
        Content->>Chrome: chrome.storage.local.set()
        Note right of Content: Update hidden domains list
        
        Content->>Content: invalidateHiddenDomainsCache()
        Content->>Content: hideChatToggle()
        Content-->>User: Chat toggle hidden
        deactivate Content
        
        %% Show Chat Toggle on Hidden Domain Flow
        User->>Content: Use Alt+M to show chat toggle
        activate Content
        Content->>Content: showChatToggle()
        Content->>Content: shouldHideChatToggle()
        Content->>Chrome: chrome.storage.local.get()
        Chrome-->>Content: hiddenDomains
        
        alt Domain is in Hidden List
            Content->>Content: Ask to keep domain hidden
            
            alt User chooses to keep hidden
                Content-->>User: Display notification
                Content->>Content: Keep domain in hidden list
            else User chooses to show toggle
                Content->>Content: removeDomainFromHiddenList()
                Content->>Chrome: chrome.storage.local.set()
                Note right of Content: Remove domain from hidden list
                Content->>Content: invalidateHiddenDomainsCache() 
                Content->>Content: showChatToggle()
                Content-->>User: Chat toggle visible
            end
        else Domain is not Hidden
            Content->>Content: showChatToggle()
            Content-->>User: Chat toggle visible
        end
        deactivate Content
        
        %% Manage Hidden Domains in Popup
        User->>Chrome: Open extension popup
        Chrome->>Chrome: extension-popup.js
        activate Chrome
        Chrome-->>User: Display main popup
        
        User->>Chrome: Click "Re-Enable for Domains"
        Chrome->>Chrome: Navigate to domains page
        Chrome-->>User: Display domains page
        
        Chrome->>Background: getHiddenDomains()
        Background->>Chrome: chrome.storage.local.get()
        Chrome-->>Background: hiddenDomains
        Background-->>Chrome: domains list
        Chrome-->>User: Display hidden domains
        
        User->>Chrome: Click to remove domain
        Chrome->>Background: removeDomainFromHidden()
        Background->>Chrome: chrome.storage.local.get()
        Chrome-->>Background: hiddenDomains
        Background->>Chrome: chrome.storage.local.set()
        Background-->>Chrome: domain removed
        Chrome-->>User: Updated hidden domains list
        
        User->>Chrome: Click "Clear All"
        Chrome->>Background: clearHiddenDomains()
        Background->>Chrome: chrome.storage.local.set()
        Background-->>Chrome: all domains cleared
        Chrome-->>User: Empty hidden domains list
        
        User->>Chrome: Click "Back"
        Chrome->>Chrome: Navigate to main popup
        Chrome-->>User: Display main popup
        deactivate Chrome
    end
        
    %% Request Preparation
    rect rgb(240, 240, 240)
        Note over User,Gemini: 3. Request Preparation
        par Gather Conversation Context
            Chat->>Conv: getHistory()
            Conv-->>Chat: conversation history
        and Capture Visual Context
            alt Heuristic detection determines isDynamicWebApp
                Content->>Content: captureScreenWithoutInterface()
                Content->>Content: enhanceScreenshot()
                Content-->>Chat: screenshot data
                Note right of Content: Visual context captured for dynamic apps<br/>based on heuristic analysis results
            end
        end

        Chat->>Chat: generateChatGPTResponse(prompt, screenshot?, config)
        Note over Chat: config: {<br/>provider: "openai" | "gemini",<br/>model: string<br/>}
    end

    %% API Communication
    rect rgb(240, 240, 240)
        Note over User,Gemini: 4. API Communication
        critical Process Request
            Chat->>API: POST /api/chat
            activate API
            Note over Chat,API: {<br/>messages: Array<Message>,<br/>provider: "openai" | "gemini",<br/>model: string<br/>}

            API->>API: handleMessages()
            API->>API: extractPromptAndScreenshot()

            alt OpenAI Provider
                API->>OpenAI: new OpenAIHandler()
                activate OpenAI
                API->>OpenAI: streamResponse(messages, model, res)
                OpenAI-->>API: SSE chunks
                deactivate OpenAI
            else Gemini Provider
                API->>Gemini: new GeminiHandler()
                activate Gemini
                API->>Gemini: streamResponse(messages, model, res)
                Gemini-->>API: SSE chunks
                deactivate Gemini
            end

            API-->>Chat: SSE response chunks
            deactivate API
        option Network Error
            API-->>Chat: Connection failed
            Chat->>Background: Log error
            Background-->>Chat: Logged
        end
    end

    %% Response Handling
    rect rgb(240, 240, 240)
        Note over User,Gemini: 5. Response Handling
        Chat->>Content: handleStreamingUpdate(chunk)
        activate Content
        par UI Updates
            Content->>Content: renderMarkdown()
            Content->>Content: createPageLinks()
            Content->>Content: checkAndExpandContent()
        and History Management
            Chat->>Conv: addToHistory(messages)
            Conv-->>Chat: history updated
        end
        Content-->>User: UI updated
        deactivate Content
        deactivate Chat

        User->>Content: View response
    end

    %% Error Handling
    rect rgb(240, 240, 240)
        Note over User,Gemini: 6. Error Handling
        User->>Content: Invalid request
        activate Content
        Content->>Chat: sendPrompt(invalid)
        activate Chat
        Chat->>API: POST /api/chat
        activate API
        API-->>Chat: Error response
        Chat->>Background: Log error
        Background-->>Chat: Logged
        Chat->>Content: handleStreamingUpdate(error)
        Content->>Content: showError()
        Content->>Content: resetUIState()
        deactivate Content
        deactivate Chat
        deactivate API
    end
